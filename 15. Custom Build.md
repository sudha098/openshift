## ğŸ› ï¸ **Custom Build Strategy â€” OpenShift**

The **Custom Build Strategy** in OpenShift allows you to build container images using **a fully custom build process** defined and executed inside a **custom builder image**.
It is used when S2I, Docker, or Buildah strategies do not provide enough flexibility.

---

### ğŸ” **When to use Custom Build**

Choose **Custom Build** when you need:

| Requirement                | Explanation                                              |
| -------------------------- | -------------------------------------------------------- |
| Custom build logic         | You want to run scripts, CI tooling, or custom workflows |
| Proprietary build tools    | Compilers / software requiring special licensing         |
| Multi-step complex builds  | e.g., binary build â†’ signing â†’ packaging                 |
| Non-standard build process | Example: FPGA, firmware, ML model packaging              |

---

### ğŸ§  **How Custom Build Works**

1ï¸âƒ£ You provide a **builder image** containing:

* Build dependencies
* Custom build scripts / tools
* Optional Docker or Buildah to produce final image

2ï¸âƒ£ OpenShift launches a build pod using your builder image

3ï¸âƒ£ Your script runs inside the pod and:

* Pulls source
* Builds artifacts
* Creates final container image
* Pushes image to destination registry

---

### ğŸ“Œ Sample BuildConfig (Custom Strategy)

```yaml
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: custom-build-demo
spec:
  source:
    git:
      uri: https://github.com/example-org/custom-app.git
  strategy:
    type: Custom
    customStrategy:
      from:
        kind: ImageStreamTag
        name: custom-builder:latest
      exposeDockerSocket: false
  output:
    to:
      kind: ImageStreamTag
      name: custom-app:latest
```

---

### ğŸ”§ What's inside the **builder image**

A custom builder image must contain:

| Component        | Purpose                                               |
| ---------------- | ----------------------------------------------------- |
| `/usr/bin/build` | Executable script triggered by OpenShift              |
| Build tools      | e.g., mvn, gradle, npm, go, compilers, ML libraries   |
| OCI image tools  | Docker, Buildah, Podman (optional if producing image) |

Example directory structure inside builder image:

```
/usr/bin/build            â† Mandatory script called during build
/usr/local/bin/*          â† Your custom tools
/workdir                  â† Build working directory
```

---

### â–¶ï¸ Execution flow

```bash
# Inside builder image
/build script runs â†’
  receives environment variables from OpenShift â†’
  fetches source â†’
  executes build logic â†’ 
  builds container image via Docker / Buildah / Podman â†’
  pushes final image to registry â†’
  exits
```

---

### ğŸ“¦ Build environment variables provided by OpenShift

| Variable            | Meaning                          |
| ------------------- | -------------------------------- |
| `SOURCE_REPOSITORY` | Git repository URL               |
| `SOURCE_REF`        | Branch / tag / commit            |
| `OUTPUT_IMAGE`      | Destination registry + image tag |
| `BUILD_LOGLEVEL`    | Logging level                    |

You can also define your own **parameters / secrets** for signing or uploads.

---

### ğŸ—ï¸ Example workflow using **Buildah inside Custom Build**

Inside `/usr/bin/build`:

```bash
#!/bin/bash
set -e

git clone "$SOURCE_REPOSITORY" /src
cd /src

# Build artifact
mvn clean install -DskipTests

# Build image using Buildah
buildah bud -t $OUTPUT_IMAGE .
buildah push $OUTPUT_IMAGE
```

---

### ğŸ” Security considerations

| Option                     | Result                                                   |
| -------------------------- | -------------------------------------------------------- |
| `exposeDockerSocket: true` | Gives build access to host Docker â€” not recommended      |
| Use Buildah                | More secure rootless building                            |
| Mount secrets              | Needed for private repository or registry authentication |

---

### ğŸš€ Strengths vs Other Build Strategies

| Strategy            | When to use                                 |
| ------------------- | ------------------------------------------- |
| **S2I**             | Typical source â†’ runtime builds             |
| **Dockerfile**      | When Dockerfile exists and is enough        |
| **Buildah**         | Rootless Dockerfile-style builds            |
| **ğŸ”¹ Custom Build** | Fully custom logic, most flexible, powerful |

---

### ğŸ§¾ Summary

| Feature                   | Support                             |
| ------------------------- | ----------------------------------- |
| Pulling source            | âœ”                                   |
| No Dockerfile required    | âœ”                                   |
| Developer-defined process | âœ”                                   |
| Incremental builds        | âŒ (unless implemented manually)     |
| Security risk             | Medium/High depending on tools used |

---
